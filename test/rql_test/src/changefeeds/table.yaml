desc: Test changefeeds on a table
table_variable_name: tbl
tests:
    
    # - start feeds
    
    - cd: all = tbl.changes()
    
    # - note: no initial values from table changefeeds
    
    # - inserts
    
    - cd: tbl.insert([{'id':1}, {'id':2}])
      ot: partial({'errors':0, 'inserted':2})
    - cd: fetch(all, 2)
      ot: bag([{'old_val':null, 'new_val':{'id':1}}, {'old_val':null, 'new_val':{'id':2}}])
    
    # - updates
    
    - cd: tbl.get(1).update({'version':1})
      ot: partial({'errors':0, 'replaced':1})
    - cd: fetch(all, 1)
      ot: [{'old_val':{'id':1}, 'new_val':{'id':1, 'version':1}}]
    
    # - deletions
    
    - cd: tbl.get(1).delete()
      ot: partial({'errors':0, 'deleted':1})
    - cd: fetch(all, 1)
      ot: [{'old_val':{'id':1, 'version':1}, 'new_val':null}]
    
    # - pluck on values
    
    - cd: pluck = tbl.get(2).changes().pluck({'new_val':['id']})
    - cd: tbl.get(2).update({'update':True})
      ot: partial({'errors':0, 'replaced':1})
    - cd: fetch(pluck, 2)
      ot: [{'new_val':{'id':2}}, {'new_val':{'id':2}}]
    
    # - changes overflow
#      
# ToDo: enable this when we can reduce the number of items to generate the overflow
#      
#    - cd: overflow = tbl.changes()
#    # add more than 100,000 entries to make sure we get the overflow error
#    - cd: r.between(1, 100002).for_each(tbl.insert({}))
#    - cd: overflow
#      ot: error(RqlDriverError, 'Changefeed cache over array size limit, skipped 1 elements.')
#      

   